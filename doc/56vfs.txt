整个文件同步系统分成3层，FCS层（源服务器），Tracker层（中间调度层），CS层（末端服务器）；实线是信令线，长连接；虚线是文件传输线和目录同步线，短连接。


每个Tracker连接到所有的FCS，每个Tracker的地位完全对等，任务的分发取决于当时Tracker的服务状态和任务的属性。

CS连接到所有的Tracker，这样就间接连接到所有的FCS了。

各层功能及模块划分。
FCS层：
A）：存储视频源文件，转换机转换后的文件直接上传到fcs；
B）：需要在FCS上新增一个服务端，作用：文件系统有更新时，主动通知连接上来的tracker。
C）：允许CS请求文件。
D）：允许CS发出目录同步请求。

Tracker层：
	A）：连接FCS；开放端口供CS连接，起到CS和FCS的桥梁作用；
	B）：根据配置信息，将FCS更新的文件列表信息，传递到CS；
	C）：保存每个文件在整个集群的一个基础信息，包括文件名，所在域名，MD5，各个末端机该文件的信息。
	D）：末端机需要更新某个文件时，首先到对应的Tracker查询该文件在集群的信息，末端机根据配置决定是就近获取文件，还是去FCS源服务器获取。
E）：保存整个Tracker层的服务器列表，供下游CS服务器获取。

CS层：
	A）：主动连接所有的Tracker。（Tracker列表可以本地配置，也可以通过指令从某一台Tracker获取）
	B）：根据Tracker传递过来的更新文件列表，保存任务，从Tracker获取文件更新地址。
	C）：开放端口，供其他CS连接过来，获取指定文件。
D）：允许FCS发出目录同步请求。
E）：允许其他CS发出目录同步请求。

关于文件目录同步的功能说明：
同步触发条件：
1，	当FCS或者CS有设备变更时，新增或者磁盘损坏替换，通过发指令，由变更一方发起一个同步，由Tracker通过读取本地配置信息，决定这个同步请求分发到哪些机器。
同步的时间点由发起方通过指令传输到Tracker。
2，	根据配置，每隔一段时间（一天或者一周），发起一个全量同步的请求。（全量同步请求的rsync源应该是FCS）

容灾功能的说明：
鉴于Tracker模块在整个系统的核心作用，必须对Tracker做容灾设计。
1，	每个Tracker的地位是对等的。每个Tracker可以服务任何一个任务，服务任何域名下的任何文件同步。
2，	每个Tracker保存当前Tracker层的活动信息，有哪些Tracker可用，哪些Tracker不可用；当有新的CS加入时，通过获取Tracker列表信息，逐个建立连接。
3，	FCS有新的任务时，会根据当前活动的Tracker数，以及任务的两级目录hash值，选取一个Tracker进行任务分发，如果该Tracker不能处理新的任务（资源限制或者当前活动任务过重），会选取该Tracker附近的Tracker进行派发。
4，	某个Tracker出现问题（倒掉，移走，暂停服务），其他Tracker在没有这个Tracker的心跳后，从活动Tracker列表删除该Tracker；CS和FCS也从活动的Tracker中摘除死掉的链接。
5，	新增Tracker，Tracker会主动连接FCS，同时将自己可提供服务的状态同步到其他Tracker，其他Tracker通知CS主动连接新的Tracker。

一批新任务的流程：
1，	某个FCS发起一个任务，根据当前Tracker数目及目录的hash值，选择一个Tracker下发任务，记录发起任务时间，以便统计任务完成时间；
2，	Tracker根据任务目录和配置信息得到需要更新的CS列表，下发任务到对应CS；选择一个负载较轻的CS作为源服务器执行该任务；
3，	CS得到任务后，首先检查本地文件是否存在（检验MD5），不存在则从该Tracker获取该文件资源列表；优先从本组本运营商的其他机器获取数据。
4，	CS将任务完成信息上报到对应Tracker，更新本地同步时间戳；Tracker校验所有任务完成后，返回该任务的完成信息到FCS，FCS删除活动任务列表，更新本地同步时间戳；Tracker将活动任务移到历史任务。
5，	每个任务ID包含：来源服务器，文件路径，发起同步时间戳。
6，	在执行任务的过程中，如果FCS，Tracker或者CS层有故障，处理逻辑如下：
A）：FCS故障，如果CS中任何一台已经执行完该任务，则由Tracker继续调度完成此次任务，完成后将任务移动历史任务中；待FCS恢复，会根据本地更新的时间戳重新发起任务，由某台Tracker调度任务，CS本地已经完成该任务，Tracker返回信息到FCS，FCS更新本地同步时间戳。 如果CS中没有一台完成任务，则Tracker取消掉本次任务，FCS恢复后，根据本地同步时间戳自行重新发起任务。
B）：Tracker故障，CS检测到跟该Tracker关联的任务，完成任务的，更新自己的同步时间戳，未完成任务的，取消本次任务（无法调度了）。FCS在检测到该Tracker的关闭后，向其他Tracker继续发起未完成的任务。
C）：CS故障，Tracker检测到CS断掉后，将该CS从任务列表的CS排除，继续跟做正常的CS任务完成状态；CS恢复后，向Tracker层汇报自己的同步时间戳。Tracker层根据时间戳，从历史任务列表中信息，调度该台CS同步文件。


时间戳说明：FCS记录的是本机的各个目录同步出去的时间戳；数量30*30
Tracker记录的是各个FCS的各个目录的同步时间戳；数量30*30*100
CS记录的是各个目录下各个FCS的同步时间戳：大约是（10~30） * 100

为了支持断点续传，和后续支持文件块同步。
实时文件同步请求由被同步一方发起，制订协议支持扩展需求。

差量或者全量文件同步，由同步一方根据被同步一方的同步时间戳发起。差量同步和全量同步，是按照目录逐个进行。
